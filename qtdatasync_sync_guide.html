<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QtDataSync: Adding background synchronization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="display: inline;">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">QtDataSync
   &#160;<span id="projectnumber">4.2.0</span>
   </div>
   <div id="projectbrief">A simple offline-first synchronisation framework, to synchronize data of Qt applications between devices</div>
  </td>
 </tr>
 </tbody>
</table>
<a style="float: right;" target="_blank"  href="https://github.com/Skycoder42/QtDataSync">
<img style="padding: 10px;" src="GitHub_Logo.png"/>
</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Adding background synchronization </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#qtdatasync_sync_guide_android">Android Background synchronization</a><ul><li class="level2"><a href="#qtdatasync_sync_guide_android_base">Prepare the project</a></li>
<li class="level2"><a href="#qtdatasync_sync_guide_android_service">Add the synchronization service to C++</a><ul><li class="level3"><a href="#qtdatasync_sync_guide_android_service_cpp">Implement the service interface</a></li>
<li class="level3"><a href="#qtdatasync_sync_guide_android_service_main">Prepare the main to run the service</a></li>
</ul>
</li>
<li class="level2"><a href="#qtdatasync_sync_guide_android_manifest">Update the AndroidManifest.xml</a><ul><li class="level3"><a href="#qtdatasync_sync_guide_android_manifest_service">Add the service</a></li>
<li class="level3"><a href="#qtdatasync_sync_guide_android_manifest_startup">Add the startup receiver</a></li>
<li class="level3"><a href="#qtdatasync_sync_guide_android_manifest_permissions">Add additional permissions</a></li>
</ul>
</li>
<li class="level2"><a href="#qtdatasync_sync_guide_android_controller">Use the controller to enable sync</a></li>
<li class="level2"><a href="#qtdatasync_sync_guide_android_test">Test the setup</a></li>
</ul>
</li>
<li class="level1"><a href="#qtdatasync_sync_guide_ios">Ios Background synchronization</a><ul><li class="level2"><a href="#qtdatasync_sync_guide_ios_base">Prepare the project</a></li>
<li class="level2"><a href="#qtdatasync_sync_guide_ios_cpp">Add the delegate to the project</a><ul><li class="level3"><a href="#qtdatasync_sync_guide_ios_cpp_delegate">Extend the delegate (optional)</a></li>
<li class="level3"><a href="#qtdatasync_sync_guide_ios_cpp_main">Initialize and enable the delegate</a></li>
</ul>
</li>
<li class="level2"><a href="#qtdatasync_sync_guide_ios_plist">Add the Info.plist</a></li>
<li class="level2"><a href="#qtdatasync_sync_guide_ios_test">Test the setup</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>A Guide for adding background synchronization to mobile applications</p>
<p>This page consists of two guides, one for android and one for iOs, to add background synchronization to an application. There are multiple steps required that differ for each platform and those are discussed here.</p>
<h1><a class="anchor" id="qtdatasync_sync_guide_android"></a>
Android Background synchronization</h1>
<p>For Android, you will have to add an additional service to your application that is to be run in the background, independently from your main application, to perform the sync. This library already supports all the elements needed to do so, but you still need to setup the project yourself.</p>
<p>You can find a working example of this tutorial in the repository. Check out the <a href="https://github.com/Skycoder42/QtDataSync/tree/master/examples/datasync/AndroidSync">AndroidSync Sample</a>.</p>
<dl class="section note"><dt>Note</dt><dd>For the Android variant, you will have to install <a href="https://github.com/Skycoder42/QtService">QtService</a> as well.</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="class_qt_data_sync_1_1_android_background_service.html" title="An extension of QtService to create a synchronization service for android. ">QtDataSync::AndroidBackgroundService</a>, <a class="el" href="class_qt_data_sync_1_1_android_sync_control.html" title="A class to manage background synchronization for android. ">QtDataSync::AndroidSyncControl</a></dd></dl>
<h2><a class="anchor" id="qtdatasync_sync_guide_android_base"></a>
Prepare the project</h2>
<dl class="section note"><dt>Note</dt><dd>For this section it is assumed you are using QtCreator and a qmake based project. For anything else you will have to figure out yourself how to do steps equivalent to these for your build system.</dd></dl>
<p>First create any normal project in QtCreator. Select an android kit to build it and then go to "Projects &gt; Build &gt; Build Android APK" and under "Android" press "Create Templates". This should bring up a dialog to add android files to your project. Follow that wizard to add the files. Your pro file should now contain <code>ANDROID_PACKAGE_SOURCE_DIR</code>.</p>
<p>Next you have to add the correct <a class="elRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtcore/qtcore.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/qt.html">Qt</a> modules. These are: <code>QT += datasyncandroid</code>. Build and run your project. It should still function normally</p>
<h2><a class="anchor" id="qtdatasync_sync_guide_android_service"></a>
Add the synchronization service to C++</h2>
<p>The next step is to add the actual service to your project that performs the sync. This is done in 3 steps:</p>
<h3><a class="anchor" id="qtdatasync_sync_guide_android_service_cpp"></a>
Implement the service interface</h3>
<p>Add a new C++ class to the project and let it inherit from <a class="el" href="class_qt_data_sync_1_1_android_background_service.html" title="An extension of QtService to create a synchronization service for android. ">QtDataSync::AndroidBackgroundService</a>. Adjust the constructor to match the one of the parent class (beware the reference) and implement any methods you need to. The only required method to be implemented is <a class="el" href="class_qt_data_sync_1_1_android_background_service.html#acf77f16dd3744870112aa898efe08353" title="Is called on the android thread to create a foreground notification. ">QtDataSync::AndroidBackgroundService::createForegroundNotification</a>. An example would be: </p><div class="fragment"><div class="line"><span class="keyword">class </span>SyncService : <span class="keyword">public</span> <a class="code" href="class_qt_data_sync_1_1_android_background_service.html">QtDataSync::AndroidBackgroundService</a></div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">explicit</span> SyncService(<span class="keywordtype">int</span> &amp;argc, <span class="keywordtype">char</span> **argv);</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="class_qt_data_sync_1_1_android_background_service.html#a48cc44de84e67b3f940db8db39054bc9">prepareSetup</a>(<a class="code" href="class_qt_data_sync_1_1_setup.html">QtDataSync::Setup</a> &amp;setup) <span class="keyword">override</span>;</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="class_qt_data_sync_1_1_android_background_service.html#ad961ac8c0a066e3d76f5ac4bb93ea739">onSyncCompleted</a>(<a class="code" href="class_qt_data_sync_1_1_sync_manager.html#a88370b2fba5ecb3602d60e08b0a66699">QtDataSync::SyncManager::SyncState</a> state) <span class="keyword">override</span>;</div><div class="line">    QAndroidJniObject <a class="code" href="class_qt_data_sync_1_1_android_background_service.html#acf77f16dd3744870112aa898efe08353">createForegroundNotification</a>() <span class="keyword">override</span>;</div><div class="line">};</div></div><!-- fragment --><p> And the corresponding implementation: </p><div class="fragment"><div class="line">SyncService::SyncService(<span class="keywordtype">int</span> &amp;argc, <span class="keywordtype">char</span> **argv) :</div><div class="line">    AndroidBackgroundService{argc, argv}</div><div class="line">{}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> SyncService::prepareSetup(<a class="code" href="class_qt_data_sync_1_1_setup.html">QtDataSync::Setup</a> &amp;setup)</div><div class="line">{</div><div class="line">    <span class="comment">// prepare the setup here, i.e.</span></div><div class="line">    <span class="comment">// setup.setRemoteConfiguration(QtDataSync::RemoteConfig{ ... ]);</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> SyncService::onSyncCompleted(<a class="code" href="class_qt_data_sync_1_1_sync_manager.html#a88370b2fba5ecb3602d60e08b0a66699">QtDataSync::SyncManager::SyncState</a> state)</div><div class="line">{</div><div class="line">    qDebug() &lt;&lt; <span class="stringliteral">&quot;[[SYNCSERVICE]]&quot;</span> &lt;&lt; <span class="stringliteral">&quot;Sync completed in state:&quot;</span> &lt;&lt; state;</div><div class="line">    exitAfterSync();</div><div class="line">}</div></div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>The foreground notification is needed as an ongoing notification to be shown while the service is running. This is required by Android. For a basic example of how to create the notification see the <a class="el" href="class_qt_data_sync_1_1_android_background_service.html#acf77f16dd3744870112aa898efe08353" title="Is called on the android thread to create a foreground notification. ">QtDataSync::AndroidBackgroundService::createForegroundNotification</a> documentation.</dd></dl>
<h3><a class="anchor" id="qtdatasync_sync_guide_android_service_main"></a>
Prepare the main to run the service</h3>
<p>After creating the sync service class, you need to add code to your main to differentiate between whether the application is started normally or as a service.</p>
<p>The general idea is to split your main into 3 functions. One named <code>activityMain</code> which does the stuff you did before, i.e. create a gui, an <code>serviceMain</code> that launces the service and the actual <code>main</code> that now only decides which of the other two to call based on the start parameters.</p>
<p>The <code>serviceMain</code> should simply instanciate and execute the service from the given parameters: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> serviceMain(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    SyncService service{argc, argv};</div><div class="line">    <span class="keywordflow">return</span> service.exec();</div><div class="line">}</div></div><!-- fragment --><p> The actual <code>main</code> has to scan the passed arguments for the <code>--backend</code> argument. If found, the <code>serviceMain</code> should be run, otherwise the <code>activityMain</code>: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    <span class="keywordflow">for</span>(<span class="keyword">auto</span> i = 0; i &lt; argc; i++) {</div><div class="line">        <span class="keywordflow">if</span>(qstrcmp(argv[i], <span class="stringliteral">&quot;--backend&quot;</span>) == 0)</div><div class="line">            <span class="keywordflow">return</span> serviceMain(argc, argv);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> activityMain(argc, argv);</div><div class="line">}</div></div><!-- fragment --><p> Again, the <code>activityMain</code> as basically what was previously the normal <code>main</code>, just moved out into a different function.</p>
<dl class="section note"><dt>Note</dt><dd>It is also possible to create two seperate binaries and reference them. But for the sake of simplicity, only the simple method with one binary is shown here.</dd></dl>
<h2><a class="anchor" id="qtdatasync_sync_guide_android_manifest"></a>
Update the AndroidManifest.xml</h2>
<p>After the C++ code is now ready, the final step is to update the AndroidManifest.xml. We need to add a few elements to register all components and permissions that are needed to actually run the service.</p>
<h3><a class="anchor" id="qtdatasync_sync_guide_android_manifest_service"></a>
Add the service</h3>
<p>Now that the service was created and is startable if the correct command line arguments are specified, we have to add it to the manifest to make it known to the android system so it can actually be started. The <code>&lt;service&gt;</code> should be placed next to the <code>&lt;activity&gt;</code> element in the manifest, as a child of the root <code>&lt;application&gt;</code> element. The following shows an example for such a service definition:</p>
<div class="fragment"><div class="line">        &lt;<span class="keywordtype">service</span> <span class="keyword">android:process</span>=<span class="stringliteral">&quot;:service_process&quot;</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;de.skycoder42.qtservice.AndroidService&quot;</span>&gt;</div><div class="line">            <span class="comment">&lt;!-- Application to launch --&gt;</span></div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.arguments&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;--backend android&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.lib_name&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;-- %%INSERT_APP_LIB_NAME%% --&quot;</span>/&gt;</div><div class="line">            <span class="comment">&lt;!-- Ministro --&gt;</span></div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.qt_sources_resource_id&quot;</span> <span class="keyword">android:resource</span>=<span class="stringliteral">&quot;@array/qt_sources&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.repository&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;default&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.qt_libs_resource_id&quot;</span> <span class="keyword">android:resource</span>=<span class="stringliteral">&quot;@array/qt_libs&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.bundled_libs_resource_id&quot;</span> <span class="keyword">android:resource</span>=<span class="stringliteral">&quot;@array/bundled_libs&quot;</span>/&gt;</div><div class="line">            <span class="comment">&lt;!-- Deploy Qt libs as part of package --&gt;</span></div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.bundle_local_qt_libs&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;-- %%BUNDLE_LOCAL_QT_LIBS%% --&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.bundled_in_lib_resource_id&quot;</span> <span class="keyword">android:resource</span>=<span class="stringliteral">&quot;@array/bundled_in_lib&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.bundled_in_assets_resource_id&quot;</span> <span class="keyword">android:resource</span>=<span class="stringliteral">&quot;@array/bundled_in_assets&quot;</span>/&gt;</div><div class="line">            <span class="comment">&lt;!-- Run with local libs --&gt;</span></div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.use_local_qt_libs&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;-- %%USE_LOCAL_QT_LIBS%% --&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.libs_prefix&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;/data/local/tmp/qt/&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.load_local_libs&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;-- %%INSERT_LOCAL_LIBS%% --&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.load_local_jars&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;-- %%INSERT_LOCAL_JARS%% --&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.static_init_classes&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;-- %%INSERT_INIT_CLASSES%% --&quot;</span>/&gt;</div><div class="line">            <span class="comment">&lt;!--  Messages maps --&gt;</span></div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;@string/ministro_not_found_msg&quot;</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.ministro_not_found_msg&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;@string/ministro_needed_msg&quot;</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.ministro_needed_msg&quot;</span>/&gt;</div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;@string/fatal_error_msg&quot;</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.fatal_error_msg&quot;</span>/&gt;</div><div class="line">            <span class="comment">&lt;!-- Background running --&gt;</span></div><div class="line">            &lt;<span class="keywordtype">meta-data</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.app.background_running&quot;</span> <span class="keyword">android:value</span>=<span class="stringliteral">&quot;true&quot;</span>/&gt;</div><div class="line">        &lt;/<span class="keywordtype">service</span>&gt;</div></div><!-- fragment --><p> Most of the service was just copied from the <code>&lt;activity&gt;</code> element. The attributes and elements that are different from the activity and thus must be changed after copying it over are:</p><ul>
<li><code>android:process=":service_process"</code> - Makes shure the service runs in a seperate process</li>
<li><code>android:name="de.skycoder42.qtservice.AndroidService"</code> - Specify the java class to be used</li>
<li><code>&lt;meta-data android:name="android.app.arguments" android:value="--backend android"/&gt;</code> - Pass the arguments to the <code>main</code></li>
<li><code>&lt;meta-data android:name="android.app.background_running" android:value="true"/&gt;</code> - Allow background execution</li>
</ul>
<h3><a class="anchor" id="qtdatasync_sync_guide_android_manifest_startup"></a>
Add the startup receiver</h3>
<p>Now that the service has been added, we need one more component to be added to the manifest. This is the boot receiver, which is started by android after a reboot and is needed to reactive your service after a boot. The class is ready to use, so you only need to add the following to the manifest, right after the <code>&lt;service&gt;</code> element (still inside the <code>&lt;application&gt;</code> element):</p>
<div class="fragment"><div class="line">        &lt;<span class="keywordtype">receiver</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;de.skycoder42.qtdatasync.SyncBootReceiver&quot;</span>&gt;</div><div class="line">            &lt;<span class="keywordtype">intent-filter</span>&gt;</div><div class="line">                &lt;<span class="keywordtype">action</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.intent.action.BOOT_COMPLETED&quot;</span>/&gt;</div><div class="line">            &lt;/<span class="keywordtype">intent-filter</span>&gt;</div><div class="line">        &lt;/<span class="keywordtype">receiver</span>&gt;</div></div><!-- fragment --> <h3><a class="anchor" id="qtdatasync_sync_guide_android_manifest_permissions"></a>
Add additional permissions</h3>
<p>The last thing to add to the manifest are additional permissions. We need permissions to start a foreground service (which is exactly what we are doing) and allow the app to receive a signal when the system was rebooted, which is needed to reactive the service after a reboot. Simply add the following elements after the <code>%INSERT_PERMISSIONS</code> comment</p>
<div class="fragment"><div class="line">    &lt;<span class="keywordtype">uses-permission</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.permission.FOREGROUND_SERVICE&quot;</span>/&gt;</div><div class="line">    &lt;<span class="keywordtype">uses-permission</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span>/&gt;</div></div><!-- fragment --> <h2><a class="anchor" id="qtdatasync_sync_guide_android_controller"></a>
Use the controller to enable sync</h2>
<p>With all the previous steps the service is fully prepared to be used. All thats left to do is to actually use it by enabeling background synchronization. You can do this with the <a class="el" href="class_qt_data_sync_1_1_android_sync_control.html" title="A class to manage background synchronization for android. ">QtDataSync::AndroidSyncControl</a> class. In the example, it is used from QML you you can play around with the possibilities, but for the sake of this guide, the simplest way is to just statically enable it from your <code>activityMain</code>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> activityMain(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    <a class="codeRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtgui/qtgui.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/qguiapplication.html">QGuiApplication</a> app(argc, argv);</div><div class="line"></div><div class="line">    <a class="code" href="class_qt_data_sync_1_1_android_sync_control.html">QtDataSync::AndroidSyncControl</a> control;</div><div class="line">    <span class="comment">// control.setInterval(...);</span></div><div class="line">    control.<a class="code" href="class_qt_data_sync_1_1_android_sync_control.html#a7fc2878b308c9fb1b425a53792aa08a6">setEnabled</a>(<span class="keyword">true</span>);</div><div class="line">    qDebug() &lt;&lt; <span class="stringliteral">&quot;control.enabled&quot;</span> &lt;&lt; control.<a class="code" href="class_qt_data_sync_1_1_android_sync_control.html#a7beef83bb852cd2ac7fdc682d41d7100">isEnabled</a>();</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line">}</div></div><!-- fragment --><dl class="section attention"><dt>Attention</dt><dd>Do not forget to register the notification channel for the foreground notification used by the service from your activity (java code below):</dd></dl>
<div class="fragment"><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> registerNotificationChannel(Context context) {</div><div class="line">        <span class="keywordflow">if</span>(Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O)</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">        NotificationManager manager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);</div><div class="line"></div><div class="line">        <span class="comment">//create foreground channel</span></div><div class="line">        NotificationChannel foreground = <span class="keyword">new</span> NotificationChannel(ForegroundChannelId,</div><div class="line">                <span class="stringliteral">&quot;Synchronization Service&quot;</span>,</div><div class="line">                NotificationManager.IMPORTANCE_MIN);</div><div class="line">        foreground.setDescription(<span class="stringliteral">&quot;Is shown when the application synchronizes&quot;</span>);</div><div class="line">        foreground.enableLights(<span class="keyword">false</span>);</div><div class="line">        foreground.enableVibration(<span class="keyword">false</span>);</div><div class="line">        foreground.setShowBadge(<span class="keyword">false</span>);</div><div class="line">        manager.createNotificationChannel(foreground);</div><div class="line">    }</div></div><!-- fragment --> <h2><a class="anchor" id="qtdatasync_sync_guide_android_test"></a>
Test the setup</h2>
<p>With that the preperations are done and ready to test. Compile and run your application and check if you can find <code>control.enabled true</code> in the log. You can also run </p><div class="fragment"><div class="line">adb shell dumpsys alarm | grep -B 1 -A 3 <a class="codeRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtmvvm/qtmvvm.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/namespacede_1_1skycoder42_1_1_qt_mvvm_1_1_core.html">de</a>.<a class="codeRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtmvvm/qtmvvm.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/namespacede_1_1skycoder42_1_1_qt_mvvm_1_1_core.html">skycoder42</a>.<a class="code" href="namespacede_1_1skycoder42_1_1qtdatasync.html">qtdatasync</a>.backgroundsync</div></div><!-- fragment --><p> to check if the alarm was correctly registered and when synchronization is triggered the next time. Wait for the timeout to arrive and see if the service executes correctly (i.e. without crashing). You can consult the logs via </p><div class="fragment"><div class="line">adb logcat</div></div><!-- fragment --><p> to check the output of the service. You should find a message like: </p><div class="fragment"><div class="line">[[SYNCSERVICE]] Sync completed in state: &lt;some state&gt;</div></div><!-- fragment --><p>If thats the case, the service works correctly, and you can extend it as you please.</p>
<h1><a class="anchor" id="qtdatasync_sync_guide_ios"></a>
Ios Background synchronization</h1>
<p>For Ios, adding background sync requires the registration of a custom delegate that can start the synchronization as part of a background fetch operation. This is done as part of your main application and will run on the main thread - however only when the application is suspended in the background and no gui is currently shown.</p>
<p>You can find a working example of this tutorial in the repository. Check out the <a href="https://github.com/Skycoder42/QtDataSync/tree/master/examples/datasync/IosSync">IosSync Sample</a>.</p>
<dl class="section attention"><dt>Attention</dt><dd>Background fetch on Ios is badly implemented (by apple). You get no guarantee at all that your task will ever be run - if your unlucky, background synchronization will never happen. And since the logic behind that is proprietary apple stuff, there is nothing that can be done to improve the situation. Do not rely on this working for every user, as I can guarantee you it wont.</dd></dl>
<h2><a class="anchor" id="qtdatasync_sync_guide_ios_base"></a>
Prepare the project</h2>
<dl class="section note"><dt>Note</dt><dd>For this section it is assumed you are using QtCreator and a qmake based project. For anything else you will have to figure out yourself how to do steps equivalent to these for your build system.</dd></dl>
<p>First create any normal project in QtCreator and make shure you select ios or ios simulator as the kit. Next you have to add the correct <a class="elRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtcore/qtcore.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/qt.html">Qt</a> modules. These are: <code>QT += datasyncios</code>. Build and run your project. It should still function normally</p>
<h2><a class="anchor" id="qtdatasync_sync_guide_ios_cpp"></a>
Add the delegate to the project</h2>
<p>All you need to do to use this feature is to add a delegate. A default implemented delegate is already part of this library and can be used as is. However, if you want to do something with the new data after it was synchronized, you have to extend the delegate and add custom code.</p>
<p>If thats not relevant for your project, you can skip the next section and immediatly go to <a class="el" href="qtdatasync_sync_guide.html#qtdatasync_sync_guide_ios_cpp_main">Initialize and enable the delegate</a></p>
<h3><a class="anchor" id="qtdatasync_sync_guide_ios_cpp_delegate"></a>
Extend the delegate (optional)</h3>
<p>If you want to perform custom operations and synchronized data, you have to extend the <a class="el" href="class_qt_data_sync_1_1_ios_sync_delegate.html" title="A helper class to perform background synchronization on Ios. ">QtDataSync::IosSyncDelegate</a>. While there are multiple things you can customize, the only relevant method that needs to be reimplemented is <a class="el" href="class_qt_data_sync_1_1_ios_sync_delegate.html#ade14211b3770eccc8fb1ed55ee9bebfc" title="Is called by the service as soon the the synchronization has been completed. ">QtDataSync::IosSyncDelegate::onSyncCompleted</a>. An example for a custom delegate would be:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>SyncDelegate : <span class="keyword">public</span> <a class="code" href="class_qt_data_sync_1_1_ios_sync_delegate.html">QtDataSync::IosSyncDelegate</a></div><div class="line">{</div><div class="line">    Q_OBJECT</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">explicit</span> SyncDelegate(<a class="codeRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtautoupdater/qtautoupdater.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/class_q_object.html">QObject</a> *parent = <span class="keyword">nullptr</span>);</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    SyncResult <a class="code" href="class_qt_data_sync_1_1_ios_sync_delegate.html#ade14211b3770eccc8fb1ed55ee9bebfc">onSyncCompleted</a>(<a class="code" href="class_qt_data_sync_1_1_sync_manager.html#a88370b2fba5ecb3602d60e08b0a66699">QtDataSync::SyncManager::SyncState</a> state) <span class="keyword">override</span>;</div><div class="line">};</div></div><!-- fragment --><p> And the corresponding implementation:</p>
<div class="fragment"><div class="line"><a class="code" href="class_qt_data_sync_1_1_ios_sync_delegate.html#adead3a7594e0c8b04dfac2a5417c5987">QtDataSync::IosSyncDelegate::SyncResult</a> SyncDelegate::onSyncCompleted(<a class="code" href="class_qt_data_sync_1_1_sync_manager.html#a88370b2fba5ecb3602d60e08b0a66699">QtDataSync::SyncManager::SyncState</a> state)</div><div class="line">{</div><div class="line">    qInfo() &lt;&lt; <span class="stringliteral">&quot;Finished synchronization in state:&quot;</span> &lt;&lt; state;</div><div class="line">    <span class="keywordflow">return</span> IosSyncDelegate::onSyncCompleted(state);</div><div class="line">}</div></div><!-- fragment --> <h3><a class="anchor" id="qtdatasync_sync_guide_ios_cpp_main"></a>
Initialize and enable the delegate</h3>
<p>Once you have your delegate ready (either by using a custom or the default one), the last step in C++ is to register it. This is done via the <a class="el" href="class_qt_data_sync_1_1_ios_sync_delegate.html#ae6c81cd839744521387562bb13b8e1be" title="Registers a sync delegate to let it perform synchronization if needed. ">QtDataSync::IosSyncDelegate::init</a> method from withing the main function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    <a class="codeRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtcore/qtcore.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/qcoreapplication.html#setAttribute">QCoreApplication::setAttribute</a>(Qt::AA_EnableHighDpiScaling);</div><div class="line">    <a class="codeRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtgui/qtgui.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/qguiapplication.html">QGuiApplication</a> app(argc, argv);</div><div class="line"></div><div class="line">    <a class="code" href="class_qt_data_sync_1_1_ios_sync_delegate.html#ae6c81cd839744521387562bb13b8e1be">QtDataSync::IosSyncDelegate::init</a>(<span class="keyword">new</span> SyncDelegate{&amp;app});</div><div class="line">    <a class="code" href="class_qt_data_sync_1_1_ios_sync_delegate.html#acde12bb31d2fafb0788b521e09d375d8">QtDataSync::IosSyncDelegate::currentDelegate</a>()-&gt;<a class="code" href="class_qt_data_sync_1_1_ios_sync_delegate.html#a9496e8aee7816c6b1b46bfb1e24e0bfe">setEnabled</a>(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div></div><!-- fragment --><p> With that the delegate is automatically registerd and enabled in the system on every start of your application.</p>
<h2><a class="anchor" id="qtdatasync_sync_guide_ios_plist"></a>
Add the Info.plist</h2>
<p>The last thing that needs to be done is to declare that your application will use background fetch for the synchronization in the Info.plist file. If you do not already have such a file, simply copy it from your <a class="elRef" target="_blank" doxygen="/home/sky/Qt/Docs/Qt-5.11.2/qtcore/qtcore.tags:https://doc.qt.io/qt-5/" href="https://doc.qt.io/qt-5/qt.html">Qt</a> installation. The path where you can find it is currently <code>&lt;path_to_qt_version&gt;/ios/mkspecs/macx-ios-clang/Info.plist.app</code>.</p>
<p>There is only a single key-value pair that you need to add to the root <code>&lt;dict&gt;</code> element at the very bottom:</p>
<div class="fragment"><div class="line">    &lt;key&gt;UIBackgroundModes&lt;/key&gt;</div><div class="line">    &lt;array&gt;</div><div class="line">        &lt;string&gt;fetch&lt;/string&gt;</div><div class="line">    &lt;/array&gt;</div></div><!-- fragment --><p> A full example for the final Info.plist would be:</p>
<div class="fragment"><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</div><div class="line">&lt;plist version=&quot;1.0&quot;&gt;</div><div class="line">&lt;dict&gt;</div><div class="line">    &lt;key&gt;CFBundleDisplayName&lt;/key&gt;</div><div class="line">    &lt;string&gt;${PRODUCT_NAME}&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundleExecutable&lt;/key&gt;</div><div class="line">    &lt;string&gt;${EXECUTABLE_NAME}&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundleGetInfoString&lt;/key&gt;</div><div class="line">    &lt;string&gt;Created by Qt/QMake&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundleIconFile&lt;/key&gt;</div><div class="line">    &lt;string&gt;${ASSETCATALOG_COMPILER_APPICON_NAME}&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundleIdentifier&lt;/key&gt;</div><div class="line">    &lt;string&gt;${PRODUCT_BUNDLE_IDENTIFIER}&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundleName&lt;/key&gt;</div><div class="line">    &lt;string&gt;${PRODUCT_NAME}&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundlePackageType&lt;/key&gt;</div><div class="line">    &lt;string&gt;APPL&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundleShortVersionString&lt;/key&gt;</div><div class="line">    &lt;string&gt;${QMAKE_SHORT_VERSION}&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundleSignature&lt;/key&gt;</div><div class="line">    &lt;string&gt;${QMAKE_PKGINFO_TYPEINFO}&lt;/string&gt;</div><div class="line">    &lt;key&gt;CFBundleVersion&lt;/key&gt;</div><div class="line">    &lt;string&gt;${QMAKE_FULL_VERSION}&lt;/string&gt;</div><div class="line">    &lt;key&gt;LSRequiresIPhoneOS&lt;/key&gt;</div><div class="line">    &lt;true/&gt;</div><div class="line">    &lt;key&gt;MinimumOSVersion&lt;/key&gt;</div><div class="line">    &lt;string&gt;${IPHONEOS_DEPLOYMENT_TARGET}&lt;/string&gt;</div><div class="line">    &lt;key&gt;NOTE&lt;/key&gt;</div><div class="line">    &lt;string&gt;This file was generated by Qt/QMake.&lt;/string&gt;</div><div class="line">    &lt;key&gt;UILaunchStoryboardName&lt;/key&gt;</div><div class="line">    &lt;string&gt;LaunchScreen&lt;/string&gt;</div><div class="line">    &lt;key&gt;UISupportedInterfaceOrientations&lt;/key&gt;</div><div class="line">    &lt;array&gt;</div><div class="line">        &lt;string&gt;UIInterfaceOrientationPortrait&lt;/string&gt;</div><div class="line">        &lt;string&gt;UIInterfaceOrientationPortraitUpsideDown&lt;/string&gt;</div><div class="line">        &lt;string&gt;UIInterfaceOrientationLandscapeLeft&lt;/string&gt;</div><div class="line">        &lt;string&gt;UIInterfaceOrientationLandscapeRight&lt;/string&gt;</div><div class="line">    &lt;/array&gt;</div><div class="line">    &lt;!--! [plist_info_fetch] --&gt;</div><div class="line">    &lt;key&gt;UIBackgroundModes&lt;/key&gt;</div><div class="line">    &lt;array&gt;</div><div class="line">        &lt;string&gt;fetch&lt;/string&gt;</div><div class="line">    &lt;/array&gt;</div><div class="line">    &lt;!--! [plist_info_fetch] --&gt;</div><div class="line">&lt;/dict&gt;</div><div class="line">&lt;/plist&gt;</div></div><!-- fragment --><h2><a class="anchor" id="qtdatasync_sync_guide_ios_test"></a>
Test the setup</h2>
<p>Testing this on ios is rather complicated, which is why I won't document this here. A helpful articel I found that explains how to test background fetching is linked below:</p>
<p><a href="https://medium.com/livefront/how-to-debug-background-fetch-events-on-ios-29540b043adf">https://medium.com/livefront/how-to-debug-background-fetch-events-on-ios-29540b043adf</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Nov 17 2018 11:30:53 for QtDataSync by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
